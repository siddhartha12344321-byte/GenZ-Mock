<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Answers - GenZMocks</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="js/admin-data.js"></script>
    <script src="js/firebase-sync.js"></script>
    <!-- jsPDF for professional PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* SuperKalam Colors */
        :root {
            --primary-orange: #f97316;
            --correct-green: #22c55e;
            --incorrect-red: #ef4444;
            --unattempted-gray: #9ca3af;
            --subject-purple: #a855f7;
            --explanation-blue: #3b82f6;
        }

        .tab-active {
            color: var(--primary-orange);
            border-bottom: 3px solid var(--primary-orange);
        }

        .option-correct {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            border-color: var(--correct-green);
        }

        .option-incorrect {
            background: #fef2f2;
            border-color: var(--incorrect-red);
        }

        .option-selected {
            border-width: 2px;
        }

        .explanation-box {
            border-left: 4px solid var(--explanation-blue);
            background: #f8faff;
        }

        .question-nav-btn {
            transition: all 0.15s ease;
        }

        .question-nav-btn:hover {
            transform: scale(1.05);
        }

        .question-nav-btn.correct {
            background: var(--correct-green);
            color: white;
        }

        .question-nav-btn.incorrect {
            background: var(--incorrect-red);
            color: white;
        }

        .question-nav-btn.unattempted {
            background: #e5e7eb;
            color: #6b7280;
        }

        .subject-tag {
            background: #faf5ff;
            color: var(--subject-purple);
            border: 1px solid #e9d5ff;
        }

        .status-badge {
            background: #f3f4f6;
            color: #6b7280;
        }

        .status-badge.correct {
            background: #dcfce7;
            color: #16a34a;
        }

        .status-badge.incorrect {
            background: #fef2f2;
            color: #dc2626;
        }

        .letter-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            flex-shrink: 0;
        }

        .letter-circle.default {
            background: #f3f4f6;
            color: #374151;
        }

        .letter-circle.correct {
            background: var(--correct-green);
            color: white;
        }

        .letter-circle.incorrect {
            background: var(--incorrect-red);
            color: white;
        }

        .checkmark-icon {
            width: 24px;
            height: 24px;
            background: var(--correct-green);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">
    <!-- Header with Tabs -->
    <header class="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-6">
            <div class="flex items-center justify-between py-4">
                <div class="flex items-center gap-8">
                    <!-- Tabs -->
                    <a href="results.html" id="tabAnalysis"
                        class="text-gray-500 hover:text-gray-700 font-medium py-2 px-1 border-b-3 border-transparent">
                        Test Analysis
                    </a>
                    <a href="#" id="tabAnswers" class="tab-active font-semibold py-2 px-1">
                        Answers
                    </a>
                </div>

                <div class="flex items-center gap-4">
                    <!-- Attempt Selector -->
                    <select id="attemptSelect"
                        class="border border-gray-300 rounded-lg px-4 py-2 text-sm font-medium bg-white">
                        <option>1st Attempt - 11 Dec '25</option>
                    </select>

                    <!-- Download PDF Button -->
                    <button onclick="downloadAnswers()"
                        class="flex items-center gap-2 px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg font-medium transition-colors">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                            <path
                                d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6zm-1 2l5 5h-5V4zm-3 9v4h2v-4h2l-3-3-3 3h2z" />
                        </svg>
                        Download PDF
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-6xl mx-auto px-6 py-8">
        <div class="flex gap-8">
            <!-- Questions List -->
            <div class="flex-1 space-y-6" id="questionsContainer">
                <!-- Questions will be rendered here -->
                <div class="text-center py-12 text-gray-500">
                    Loading answers...
                </div>
            </div>

            <!-- Sidebar -->
            <aside class="w-72 flex-shrink-0">
                <div class="sticky top-24 space-y-4">
                    <!-- Questions Navigation -->
                    <div class="bg-white rounded-xl border border-gray-200 p-4">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-semibold text-gray-800">Questions</h3>
                            <div class="flex gap-1">
                                <button onclick="scrollToQuestion('prev')"
                                    class="w-7 h-7 bg-gray-100 rounded flex items-center justify-center hover:bg-gray-200">
                                    â—€
                                </button>
                                <button onclick="scrollToQuestion('next')"
                                    class="w-7 h-7 bg-gray-100 rounded flex items-center justify-center hover:bg-gray-200">
                                    â–¶
                                </button>
                            </div>
                        </div>
                        <div class="grid grid-cols-5 gap-2" id="questionNav">
                            <!-- Question buttons will be rendered here -->
                        </div>
                    </div>

                    <!-- Legend -->
                    <div class="bg-white rounded-xl border border-gray-200 p-4">
                        <div class="space-y-3">
                            <div class="flex items-center gap-3">
                                <div class="w-6 h-6 bg-green-500 rounded"></div>
                                <span class="text-sm text-gray-600">Correct</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="w-6 h-6 bg-red-500 rounded"></div>
                                <span class="text-sm text-gray-600">Incorrect</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="w-6 h-6 bg-gray-300 rounded"></div>
                                <span class="text-sm text-gray-600">Unattempted</span>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>
        </div>
    </main>

    <script>
        // Get test data from URL
        const params = new URLSearchParams(window.location.search);
        const testId = params.get('testId');
        const attemptNum = params.get('attempt') || 1;

        // Load test answers from localStorage
        let testData = null;
        let questions = [];
        let userAnswers = {};

        function getTestFromStorage(id) {
            const tests = JSON.parse(localStorage.getItem('genz_mock_tests') || '[]');
            return tests.find(t => t.id === id);
        }

        function getQuestionsFromStorage(id) {
            const allQuestions = JSON.parse(localStorage.getItem('genz_questions') || '[]');
            return allQuestions.filter(q => q.test_id === id);
        }

        function getAttemptData(id, attemptNum) {
            const testAttempts = JSON.parse(localStorage.getItem('test_attempts') || '{}');
            const attempts = testAttempts[id] || [];
            return attempts[attemptNum - 1] || null;
        }

        // Load saved answers from submitted test
        function loadSavedAnswers(id) {
            // First try the answers key (saved on submit)
            const answersKey = `test_answers_${id}`;
            const savedAnswers = localStorage.getItem(answersKey);
            if (savedAnswers) {
                try {
                    const data = JSON.parse(savedAnswers);
                    return data.answers || {};
                } catch (e) {
                    console.error('Failed to load answers:', e);
                }
            }

            // Fallback to progress key (for in-progress tests)
            const progressKey = `test_progress_${id}`;
            const savedProgress = localStorage.getItem(progressKey);
            if (savedProgress) {
                try {
                    const data = JSON.parse(savedProgress);
                    return data.answers || {};
                } catch (e) {
                    return {};
                }
            }
            return {};
        }

        // Render questions
        async function renderQuestions() {
            testData = testId ? getTestFromStorage(testId) : null;
            questions = testId ? getQuestionsFromStorage(testId) : [];
            userAnswers = loadSavedAnswers(testId);

            // Also try to load questions from saved test answers (new format)
            if (questions.length === 0 && testId) {
                const answersKey = `test_answers_${testId}`;
                const savedData = localStorage.getItem(answersKey);
                if (savedData) {
                    try {
                        const data = JSON.parse(savedData);
                        if (data.questions && Array.isArray(data.questions)) {
                            questions = data.questions;
                            console.log('ðŸ“š Loaded', questions.length, 'questions from test_answers');
                        }
                    } catch (e) {
                        console.error('Failed to parse saved questions:', e);
                    }
                }
            }

            console.log('ðŸ“š Answers page loaded:', { testId, testData, questionsCount: questions.length, userAnswers });

            // Try Firebase if no local questions
            if (questions.length === 0 && window.FirebaseSync && testId) {
                console.log('âš ï¸ No local questions, trying Firebase...');
                try {
                    const firebaseQuestions = await FirebaseSync.getQuestionsByTestId(testId);
                    if (firebaseQuestions && firebaseQuestions.length > 0) {
                        questions = firebaseQuestions;
                        // Save to localStorage for future use
                        let allQuestions = JSON.parse(localStorage.getItem('genz_questions') || '[]');
                        allQuestions = allQuestions.filter(q => q.test_id !== testId);
                        allQuestions.push(...firebaseQuestions);
                        localStorage.setItem('genz_questions', JSON.stringify(allQuestions));
                        console.log('âœ… Loaded', questions.length, 'questions from Firebase');
                    }
                } catch (e) {
                    console.error('Firebase question load failed:', e);
                }
            }

            // Fallback demo if no questions
            if (questions.length === 0) {
                questions = [
                    {
                        question_text_en: 'With reference to the evolution of federalism in India, consider the following statements:\n1. The Simon Commission Report (1930) was the first official document to recommend a federal system for India.\n2. The Government of India Act, 1935 fully operationalized the federal provisions, bringing both British India and the Princely States into a common federal structure.\n3. The Union Powers Committee of the Constituent Assembly recommended vesting residuary powers in the Centre rather than the States.\nWhich of the statements given above is/are correct?',
                        option_a_en: '1 and 2 only',
                        option_b_en: '1 and 3 only',
                        option_c_en: '2 and 3 only',
                        option_d_en: '1, 2 and 3',
                        correct_option: 'b',
                        explanation_en: 'Statement 1: Correct\nThe Simon Commission Report (1930) laid the earliest official foundation for a federal system in India. It emphasized the need for an all-India federation.\n\nStatement 2: Incorrect\nThe Government of India Act, 1935 provided for a federation of British Indian provinces and princely states. However, the federal provisions never came into force because princely states were reluctant to join.\n\nStatement 3: Correct\nIn the Constituent Assembly, the Union Powers Committee recommended that residuary powers should vest in the Centre, not in the States.',
                        subject_id: 'polity'
                    },
                    {
                        question_text_en: 'Which of the following features tilt India\'s federal scheme towards a strong Centre?\n1. Residuary powers with the Union\n2. Overriding power of Union law on Concurrent List conflicts\n3. More important subjects placed in the Union List\nWhich of the statements given above is/are correct?',
                        option_a_en: '1 and 2 only',
                        option_b_en: '2 and 3 only',
                        option_c_en: '1 and 3 only',
                        option_d_en: '1, 2 and 3',
                        correct_option: 'd',
                        explanation_en: 'All three statements are correct.\n\nResiduary powers, unlike in the USA, are vested in the Union. Article 248 and Entry 97 of List I give the Centre exclusive power to legislate on any matter not enumerated in the three lists.\n\nIn case of conflict between Union and State laws on Concurrent List subjects, Union law prevails (Article 254).\n\nThe most important subjects like defence, foreign affairs, atomic energy, and banking are in the Union List.',
                        subject_id: 'polity'
                    }
                ];
            }

            const container = document.getElementById('questionsContainer');
            const letters = ['A', 'B', 'C', 'D'];
            const correctMap = { 'a': 0, 'b': 1, 'c': 2, 'd': 3 };

            container.innerHTML = questions.map((q, idx) => {
                // Support both old format (option_a_en) and new format (options array)
                let options;
                if (q.options && Array.isArray(q.options)) {
                    options = q.options;
                } else {
                    options = [
                        q.option_a_en || q.option_a || '',
                        q.option_b_en || q.option_b || '',
                        q.option_c_en || q.option_c || '',
                        q.option_d_en || q.option_d || ''
                    ];
                }

                // Support both correct_option (letter/index) formats
                let correctIdx;
                if (typeof q.correct_option === 'number') {
                    correctIdx = q.correct_option;
                } else {
                    correctIdx = correctMap[q.correct_option?.toLowerCase()] ?? 0;
                }

                const userAnswer = userAnswers[idx];
                const isAttempted = userAnswer !== undefined;
                const isCorrect = userAnswer === correctIdx;

                // Status badge
                let statusBadge = '<span class="status-badge px-3 py-1 rounded-full text-xs font-medium">âŠ– Unattempted</span>';
                if (isAttempted) {
                    statusBadge = isCorrect
                        ? '<span class="status-badge correct px-3 py-1 rounded-full text-xs font-medium">âœ“ Correct</span>'
                        : '<span class="status-badge incorrect px-3 py-1 rounded-full text-xs font-medium">âœ— Incorrect</span>';
                }

                // Subject tag
                const subject = q.subject_id || testData?.subject_id || 'General';
                const subjectName = subject.charAt(0).toUpperCase() + subject.slice(1).replace('_', ' ');

                // Format question text with line breaks
                const questionText = (q.question_en || q.question_text_en || q.question_text || q.text || '')
                    .replace(/\n/g, '<br>');

                // Render options
                const optionsHtml = options.map((opt, i) => {
                    let optionClass = 'border border-gray-200 bg-white';
                    let letterClass = 'letter-circle default';
                    let checkmark = '';

                    if (i === correctIdx) {
                        optionClass = 'option-correct border-2 border-green-400';
                        letterClass = 'letter-circle correct';
                        checkmark = '<div class="checkmark-icon">âœ“</div>';
                    } else if (userAnswer === i && !isCorrect) {
                        optionClass = 'option-incorrect border-2 border-red-400';
                        letterClass = 'letter-circle incorrect';
                    }

                    if (userAnswer === i) {
                        optionClass += ' option-selected';
                    }

                    return `
                        <div class="${optionClass} rounded-xl p-4 flex items-center gap-4">
                            <div class="${letterClass}">${letters[i]}</div>
                            <div class="flex-1 text-gray-700">${opt}</div>
                            ${i === correctIdx ? checkmark : ''}
                        </div>
                    `;
                }).join('');

                // Format explanation
                const explanation = (q.explanation || q.explanation_en || 'No explanation available.')
                    .replace(/\n/g, '<br>')
                    .replace(/Statement (\d+): (Correct|Incorrect)/g, '<strong>Statement $1: $2</strong>');

                return `
                    <div class="bg-white rounded-2xl border border-gray-200 p-6" id="question-${idx}">
                        <!-- Question Header -->
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-4">
                                <h2 class="text-lg font-bold text-orange-500">QUESTION ${idx + 1}</h2>
                                ${statusBadge}
                            </div>
                            <span class="subject-tag px-3 py-1 rounded-full text-sm font-medium">${subjectName}</span>
                        </div>

                        <!-- Question Text -->
                        <div class="text-gray-800 leading-relaxed mb-6">
                            ${questionText}
                        </div>

                        <!-- Options -->
                        <div class="space-y-3 mb-6">
                            ${optionsHtml}
                        </div>

                        <!-- Correct Answer -->
                        <div class="border-t border-gray-100 pt-6">
                            <div class="font-semibold text-gray-800 mb-3">
                                Correct Answer: <span class="text-blue-600">${letters[correctIdx]}</span>
                            </div>

                            <!-- Explanation -->
                            <div class="explanation-box rounded-lg p-4">
                                <div class="text-blue-600 font-semibold mb-2">Explanation:</div>
                                <div class="text-gray-700 leading-relaxed">
                                    ${explanation}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Render question navigation
            renderQuestionNav();
        }

        function renderQuestionNav() {
            const nav = document.getElementById('questionNav');
            const correctMap = { 'a': 0, 'b': 1, 'c': 2, 'd': 3 };

            nav.innerHTML = questions.map((q, idx) => {
                const correctIdx = correctMap[q.correct_option?.toLowerCase()] ?? 0;
                const userAnswer = userAnswers[idx];
                const isAttempted = userAnswer !== undefined;
                const isCorrect = userAnswer === correctIdx;

                let btnClass = 'question-nav-btn unattempted';
                if (isAttempted) {
                    btnClass = isCorrect ? 'question-nav-btn correct' : 'question-nav-btn incorrect';
                }

                return `
                    <button onclick="scrollToQuestionById(${idx})"
                        class="${btnClass} w-9 h-9 rounded-lg font-semibold text-sm flex items-center justify-center">
                        ${idx + 1}
                    </button>
                `;
            }).join('');
        }

        function scrollToQuestionById(idx) {
            document.getElementById(`question-${idx}`)?.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        let currentQuestionIdx = 0;
        function scrollToQuestion(direction) {
            if (direction === 'next' && currentQuestionIdx < questions.length - 1) {
                currentQuestionIdx++;
            } else if (direction === 'prev' && currentQuestionIdx > 0) {
                currentQuestionIdx--;
            }
            scrollToQuestionById(currentQuestionIdx);
        }

        function downloadAnswers() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const margin = 20;
            const contentWidth = pageWidth - (margin * 2);
            let yPos = 15;

            const letters = ['A', 'B', 'C', 'D'];
            const correctMap = { 'a': 0, 'b': 1, 'c': 2, 'd': 3 };

            // Colors
            const primaryOrange = [249, 115, 22];
            const darkGray = [55, 65, 81];
            const mediumGray = [107, 114, 128];
            const lightGray = [229, 231, 235];
            const correctGreen = [34, 197, 94];
            const blue = [59, 130, 246];
            const bgLight = [248, 250, 252];

            // Get test info
            const testName = testData?.name_en || 'GenZMocks Answer Key';
            const totalMarks = questions.length * 2;
            const totalTime = testData?.duration_minutes || 10;
            const attemptDate = new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: '2-digit' });

            // ===== HELPER FUNCTIONS =====
            function drawWatermark() {
                doc.setGState(new doc.GState({ opacity: 0.06 }));
                doc.setFontSize(100);
                doc.setTextColor(...mediumGray);
                doc.text('GZ', pageWidth / 2, pageHeight / 2 + 20, { align: 'center', angle: 30 });
                doc.setGState(new doc.GState({ opacity: 1 }));
            }

            function checkPageBreak(requiredHeight) {
                if (yPos + requiredHeight > pageHeight - 25) {
                    doc.addPage();
                    yPos = 20;
                    drawWatermark();
                    return true;
                }
                return false;
            }

            function wrapText(text, maxWidth, fontSize) {
                doc.setFontSize(fontSize);
                const lines = doc.splitTextToSize(text, maxWidth);
                return lines;
            }

            // ===== PAGE 1 HEADER =====
            drawWatermark();

            // Header bar with branding
            doc.setFillColor(249, 115, 22);
            doc.rect(0, 0, pageWidth, 22, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.text('genzmocks.com', pageWidth / 2, 10, { align: 'center' });
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            doc.text('Ace your exams with GenZMocks', pageWidth / 2, 17, { align: 'center' });

            yPos = 35;

            // Logo/Icon circle
            doc.setFillColor(...primaryOrange);
            doc.circle(pageWidth / 2, yPos, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('GZ', pageWidth / 2, yPos + 4, { align: 'center' });

            yPos += 18;

            // Test Title
            doc.setTextColor(...primaryOrange);
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            const titleLines = wrapText(testName, contentWidth, 18);
            titleLines.forEach(line => {
                doc.text(line, pageWidth / 2, yPos, { align: 'center' });
                yPos += 8;
            });

            yPos += 5;

            // Test Details Table
            const tableStartY = yPos;
            const tableWidth = 100;
            const tableX = (pageWidth - tableWidth) / 2;

            // Table header row
            doc.setFillColor(...lightGray);
            doc.rect(tableX, tableStartY, tableWidth, 8, 'F');
            doc.setDrawColor(...mediumGray);
            doc.rect(tableX, tableStartY, 50, 8, 'S');
            doc.rect(tableX + 50, tableStartY, 50, 8, 'S');

            doc.setTextColor(...darkGray);
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.text('Total Marks', tableX + 25, tableStartY + 5.5, { align: 'center' });
            doc.text('Total Time', tableX + 75, tableStartY + 5.5, { align: 'center' });

            // Table value row
            doc.setFillColor(255, 255, 255);
            doc.rect(tableX, tableStartY + 8, 50, 8, 'F');
            doc.rect(tableX + 50, tableStartY + 8, 50, 8, 'F');
            doc.rect(tableX, tableStartY + 8, 50, 8, 'S');
            doc.rect(tableX + 50, tableStartY + 8, 50, 8, 'S');

            doc.setFont('helvetica', 'normal');
            doc.text(String(totalMarks), tableX + 25, tableStartY + 13.5, { align: 'center' });
            doc.text(`${totalTime} min`, tableX + 75, tableStartY + 13.5, { align: 'center' });

            yPos = tableStartY + 25;

            // Answer Key Header
            doc.setTextColor(...darkGray);
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text('Answer Key', margin, yPos);
            yPos += 10;

            // ===== QUESTIONS LOOP =====
            questions.forEach((q, idx) => {
                // Support both formats
                let options;
                if (q.options && Array.isArray(q.options)) {
                    options = q.options;
                } else {
                    options = [
                        q.option_a_en || q.option_a || '',
                        q.option_b_en || q.option_b || '',
                        q.option_c_en || q.option_c || '',
                        q.option_d_en || q.option_d || ''
                    ];
                }

                let correctIdx;
                if (typeof q.correct_option === 'number') {
                    correctIdx = q.correct_option;
                } else {
                    correctIdx = correctMap[q.correct_option?.toLowerCase()] ?? 0;
                }

                const questionText = (q.question_en || q.question_text_en || q.question_text || q.text || '')
                    .replace(/\n/g, ' ').replace(/\s+/g, ' ').trim();
                const explanation = (q.explanation || q.explanation_en || 'No explanation available.')
                    .replace(/\n/g, ' ').replace(/\s+/g, ' ').trim();

                // Estimate height needed
                const qLines = wrapText(questionText, contentWidth - 5, 10);
                const expLines = wrapText(explanation, contentWidth - 15, 9);
                const estimatedHeight = (qLines.length * 5) + (options.length * 7) + (expLines.length * 4) + 45;

                checkPageBreak(estimatedHeight);

                // Question number
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...darkGray);
                doc.text(`Question ${idx + 1}`, margin, yPos);
                yPos += 6;

                // Question text
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(...darkGray);
                qLines.forEach(line => {
                    checkPageBreak(6);
                    doc.text(line, margin + 2, yPos);
                    yPos += 5;
                });

                yPos += 3;

                // Options
                options.forEach((opt, i) => {
                    checkPageBreak(8);
                    const optText = `${letters[i]}   ${opt}`;
                    const optLines = wrapText(optText, contentWidth - 15, 9);

                    if (i === correctIdx) {
                        // Highlight correct answer with green background
                        doc.setFillColor(220, 252, 231);
                        doc.roundedRect(margin, yPos - 3.5, contentWidth, (optLines.length * 4) + 3, 2, 2, 'F');
                        doc.setTextColor(...correctGreen);
                        doc.setFont('helvetica', 'bold');
                    } else {
                        doc.setTextColor(...darkGray);
                        doc.setFont('helvetica', 'normal');
                    }

                    doc.setFontSize(9);
                    optLines.forEach(line => {
                        doc.text(line, margin + 5, yPos);
                        yPos += 4;
                    });
                    yPos += 2;
                });

                yPos += 2;

                // Correct Answer line
                checkPageBreak(8);
                doc.setTextColor(...darkGray);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('Correct Answer: ', margin, yPos);
                doc.setTextColor(...correctGreen);
                doc.text(letters[correctIdx], margin + 32, yPos);
                yPos += 8;

                // Explanation box
                checkPageBreak(15);
                doc.setFillColor(248, 250, 255);
                doc.setDrawColor(...blue);
                const expBoxHeight = Math.max((expLines.length * 4) + 12, 20);

                if (yPos + expBoxHeight > pageHeight - 20) {
                    doc.addPage();
                    yPos = 20;
                    drawWatermark();
                }

                doc.rect(margin, yPos - 2, contentWidth, expBoxHeight, 'F');
                doc.setLineWidth(0.8);
                doc.line(margin, yPos - 2, margin, yPos + expBoxHeight - 2);

                yPos += 4;
                doc.setTextColor(...blue);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('Explanation:', margin + 4, yPos);
                yPos += 5;

                doc.setTextColor(...darkGray);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                expLines.forEach(line => {
                    doc.text(line, margin + 4, yPos);
                    yPos += 4;
                });

                yPos += 12;

                // Separator line between questions
                if (idx < questions.length - 1) {
                    checkPageBreak(5);
                    doc.setDrawColor(...lightGray);
                    doc.setLineWidth(0.3);
                    doc.line(margin, yPos - 5, pageWidth - margin, yPos - 5);
                }
            });

            // Footer on last page
            const totalPages = doc.internal.getNumberOfPages();
            for (let i = 1; i <= totalPages; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(...mediumGray);
                doc.text(`Page ${i} of ${totalPages}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
                doc.text(`Generated on ${attemptDate}   |   GenZMocks.com`, pageWidth / 2, pageHeight - 5, { align: 'center' });
            }

            // Generate filename
            const safeName = testName.replace(/[^a-z0-9]/gi, '-').substring(0, 40);
            doc.save(`${safeName}-answer-key.pdf`);
        }

        // Update attempt dropdown
        function updateAttemptDropdown() {
            const testAttempts = JSON.parse(localStorage.getItem('test_attempts') || '{}');
            const attempts = testAttempts[testId] || [];
            const select = document.getElementById('attemptSelect');

            if (attempts.length > 0) {
                select.innerHTML = attempts.map((a, i) => {
                    const date = new Date(a.date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: '2-digit' });
                    return `<option value="${i + 1}" ${i + 1 == attemptNum ? 'selected' : ''}>${i + 1}${getOrdinal(i + 1)} Attempt - ${date}</option>`;
                }).join('');

                select.onchange = () => {
                    window.location.href = `answers.html?testId=${testId}&attempt=${select.value}`;
                };
            }
        }

        function getOrdinal(n) {
            const s = ['th', 'st', 'nd', 'rd'];
            const v = n % 100;
            return s[(v - 20) % 10] || s[v] || s[0];
        }

        // Update tab link to preserve testId
        document.getElementById('tabAnalysis').href = `results.html?testId=${testId}&attempt=${attemptNum}`;

        // Initialize
        (async () => {
            await renderQuestions();
            updateAttemptDropdown();
        })();
    </script>
</body>

</html>