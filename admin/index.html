<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Admin Panel - Manage Gen-Z Mocks Tests">
    <title>Admin - Gen-Z Mocks</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- Styles -->
    <link rel="stylesheet" href="../css/styles.css">

    <style>
        .admin-layout {
            display: grid;
            grid-template-columns: 260px 1fr;
            min-height: 100vh;
        }

        /* Sidebar */
        .admin-sidebar {
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            padding: var(--spacing-xl);
            position: sticky;
            top: 0;
            height: 100vh;
        }

        .admin-logo {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: var(--spacing-2xl);
            color: var(--text-primary);
        }

        .admin-nav {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }

        .admin-nav-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            font-weight: 500;
            transition: all var(--transition-fast);
        }

        .admin-nav-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .admin-nav-item.active {
            background: var(--primary-600);
            color: white;
        }

        .admin-nav-item .icon {
            font-size: 1.25rem;
        }

        /* Main Content */
        .admin-main {
            padding: var(--spacing-2xl);
            background: var(--bg-primary);
        }

        .admin-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--spacing-xl);
        }

        .admin-header h1 {
            font-size: 1.75rem;
        }

        /* Stats Cards */
        .admin-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-2xl);
        }

        .admin-stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-xl);
            padding: var(--spacing-xl);
        }

        .admin-stat-card .icon {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-lg);
            font-size: 1.5rem;
            margin-bottom: var(--spacing-md);
        }

        .admin-stat-card .icon.tests {
            background: linear-gradient(135deg, #3b82f6, #60a5fa);
        }

        .admin-stat-card .icon.questions {
            background: linear-gradient(135deg, #22c55e, #4ade80);
        }

        .admin-stat-card .icon.users {
            background: linear-gradient(135deg, #f97316, #fb923c);
        }

        .admin-stat-card .icon.attempts {
            background: linear-gradient(135deg, #8b5cf6, #a78bfa);
        }

        .admin-stat-card .value {
            font-size: 2rem;
            font-weight: 700;
        }

        .admin-stat-card .label {
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        /* Table */
        .admin-table-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-xl);
            overflow: hidden;
        }

        .admin-table-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border-color);
        }

        .admin-table-header h2 {
            font-size: 1.125rem;
        }

        .admin-table {
            width: 100%;
            border-collapse: collapse;
        }

        .admin-table th,
        .admin-table td {
            padding: var(--spacing-md) var(--spacing-lg);
            text-align: left;
        }

        .admin-table th {
            background: var(--bg-tertiary);
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.8125rem;
            text-transform: uppercase;
        }

        .admin-table tr {
            border-bottom: 1px solid var(--border-light);
        }

        .admin-table tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .admin-table .title-cell {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .admin-table .test-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            font-size: 1.25rem;
        }

        .admin-table .actions {
            display: flex;
            gap: var(--spacing-sm);
        }

        .admin-table .btn-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            transition: all var(--transition-fast);
        }

        .admin-table .btn-icon:hover {
            background: var(--primary-600);
            color: white;
        }

        .admin-table .btn-icon.delete:hover {
            background: var(--error-600);
        }

        /* Create Test Modal */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-normal);
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-xl);
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-xl);
            border-bottom: 1px solid var(--border-color);
        }

        .modal-header h2 {
            font-size: 1.25rem;
        }

        .modal-close {
            font-size: 1.5rem;
            color: var(--text-muted);
            cursor: pointer;
        }

        .modal-body {
            padding: var(--spacing-xl);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-md);
            padding: var(--spacing-xl);
            border-top: 1px solid var(--border-color);
        }

        /* Form */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-lg);
        }

        .form-group {
            margin-bottom: var(--spacing-lg);
        }

        .form-label {
            display: block;
            margin-bottom: var(--spacing-sm);
            font-weight: 500;
            color: var(--text-secondary);
        }

        .form-label small {
            color: var(--text-muted);
            font-weight: 400;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: var(--spacing-md);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 1rem;
            transition: all var(--transition-fast);
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-select {
            cursor: pointer;
        }

        /* Import Section */
        .import-section {
            background: var(--bg-tertiary);
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--spacing-2xl);
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .import-section:hover {
            border-color: var(--primary-500);
            background: rgba(59, 130, 246, 0.05);
        }

        .import-section.dragover {
            border-color: var(--primary-500);
            background: rgba(59, 130, 246, 0.1);
        }

        .import-section .icon {
            font-size: 3rem;
            margin-bottom: var(--spacing-md);
        }

        .import-section h3 {
            margin-bottom: var(--spacing-sm);
        }

        .import-section p {
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .import-section input {
            display: none;
        }

        /* Marking Scheme */
        .marking-scheme {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-md);
            background: var(--bg-tertiary);
            padding: var(--spacing-lg);
            border-radius: var(--radius-md);
            margin-top: var(--spacing-md);
        }

        .marking-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .marking-item label {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .marking-item input {
            width: 80px;
            padding: var(--spacing-sm);
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            text-align: center;
        }

        @media (max-width: 1024px) {
            .admin-layout {
                grid-template-columns: 1fr;
            }

            .admin-sidebar {
                display: none;
            }

            .admin-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .admin-stats {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <!-- Admin Login Screen -->
    <div id="adminLogin" class="admin-login-overlay">
        <div class="admin-login-box">
            <div class="admin-login-header">
                <span style="font-size: 3rem;">üîê</span>
                <h2>Admin Access</h2>
                <p>Enter admin password to continue</p>
            </div>
            <form id="adminLoginForm">
                <input type="password" id="adminPassword" class="admin-password-input"
                    placeholder="Enter Admin Password" autocomplete="off" required>
                <div id="adminError" class="admin-error">‚ùå Incorrect password</div>
                <button type="submit" class="btn btn-primary" style="width: 100%; padding: 1rem;">
                    üîì Access Admin Panel
                </button>
            </form>
            <p style="margin-top: 1.5rem; font-size: 0.875rem; color: var(--text-muted);">
                <a href="../index.html">‚Üê Back to Site</a>
            </p>
        </div>
    </div>

    <style>
        .admin-login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(-45deg, #0f172a, #1e1b4b, #0f172a, #1e3a5f);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .admin-login-overlay.hidden {
            display: none;
        }

        .admin-login-box {
            background: rgba(30, 41, 59, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1.5rem;
            padding: 3rem;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        }

        .admin-login-header h2 {
            margin: 1rem 0 0.5rem;
            color: var(--text-primary);
        }

        .admin-login-header p {
            color: var(--text-muted);
            margin-bottom: 2rem;
        }

        .admin-password-input {
            width: 100%;
            padding: 1rem;
            font-size: 1.125rem;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: 0.75rem;
            color: var(--text-primary);
            text-align: center;
            margin-bottom: 1rem;
        }

        .admin-password-input:focus {
            outline: none;
            border-color: var(--primary-500);
        }

        .admin-error {
            color: #ef4444;
            margin-bottom: 1rem;
            display: none;
        }

        .admin-error.show {
            display: block;
        }
    </style>

    <script>
        // Admin Password Protection
        const ADMIN_PASSWORD = 'genz2024admin';
        const adminLogin = document.getElementById('adminLogin');
        const adminLoginForm = document.getElementById('adminLoginForm');
        const adminPassword = document.getElementById('adminPassword');
        const adminError = document.getElementById('adminError');

        // Check if already authenticated
        if (sessionStorage.getItem('admin_auth') === 'true') {
            adminLogin.classList.add('hidden');
        } else {
            adminPassword.focus();
        }

        adminLoginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (adminPassword.value === ADMIN_PASSWORD) {
                sessionStorage.setItem('admin_auth', 'true');
                adminLogin.classList.add('hidden');
            } else {
                adminError.classList.add('show');
                adminPassword.value = '';
                adminPassword.focus();
            }
        });
    </script>

    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <div class="admin-logo">
                <span>üöÄ</span>
                <span>Gen-Z Admin</span>
            </div>

            <nav class="admin-nav">
                <a href="index.html" class="admin-nav-item active">
                    <span class="icon">üìä</span>
                    <span>Dashboard</span>
                </a>
                <a href="#" class="admin-nav-item" id="navTests">
                    <span class="icon">üìù</span>
                    <span>Mock Tests</span>
                </a>
                <a href="#" class="admin-nav-item" id="navQuestions">
                    <span class="icon">‚ùì</span>
                    <span>Questions</span>
                </a>
                <a href="#" class="admin-nav-item" id="navSubjects">
                    <span class="icon">üìö</span>
                    <span>Subjects</span>
                </a>
                <a href="#" class="admin-nav-item" id="navUsers">
                    <span class="icon">üë•</span>
                    <span>Users</span>
                </a>
                <a href="#" class="admin-nav-item" id="navImport">
                    <span class="icon">üì•</span>
                    <span>Import PDF</span>
                </a>
                <a href="#" class="admin-nav-item" id="navKeys">
                    <span class="icon">üîë</span>
                    <span>Access Keys</span>
                </a>
                <a href="../dashboard.html" class="admin-nav-item">
                    <span class="icon">üåê</span>
                    <span>View Site</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="admin-main">
            <div class="admin-header">
                <h1>üìä Dashboard</h1>
                <button class="btn btn-primary" id="createTestBtn">
                    ‚ûï Create New Test
                </button>
            </div>

            <!-- Stats -->
            <div class="admin-stats">
                <div class="admin-stat-card">
                    <div class="icon tests">üìù</div>
                    <div class="value">24</div>
                    <div class="label">Total Tests</div>
                </div>
                <div class="admin-stat-card">
                    <div class="icon questions">‚ùì</div>
                    <div class="value">1,850</div>
                    <div class="label">Total Questions</div>
                </div>
                <div class="admin-stat-card">
                    <div class="icon users">üë•</div>
                    <div class="value">156</div>
                    <div class="label">Registered Users</div>
                </div>
                <div class="admin-stat-card">
                    <div class="icon attempts">üìà</div>
                    <div class="value">892</div>
                    <div class="label">Test Attempts</div>
                </div>
            </div>

            <!-- Tests Table -->
            <div class="admin-table-card">
                <div class="admin-table-header">
                    <h2>Recent Mock Tests</h2>
                    <div class="flex gap-sm">
                        <button class="btn btn-ghost btn-sm">Export</button>
                        <button class="btn btn-outline btn-sm" id="importPdfBtn">üì• Import PDF</button>
                    </div>
                </div>
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Test Name</th>
                            <th>Subject</th>
                            <th>Questions</th>
                            <th>Time</th>
                            <th>Attempts</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="testsTableBody">
                        <tr>
                            <td>
                                <div class="title-cell">
                                    <div class="test-icon">‚öñÔ∏è</div>
                                    <div>
                                        <strong>Polity Mock Test 1</strong>
                                        <div class="text-muted" style="font-size:0.75rem;">‡§∞‡§æ‡§ú‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ ‡§Æ‡•â‡§ï ‡§ü‡•á‡§∏‡•ç‡§ü 1</div>
                                    </div>
                                </div>
                            </td>
                            <td>Indian Polity</td>
                            <td>100</td>
                            <td>120 min</td>
                            <td>45</td>
                            <td><span class="badge badge-new">Active</span></td>
                            <td>
                                <div class="actions">
                                    <button class="btn-icon" title="Edit">‚úèÔ∏è</button>
                                    <button class="btn-icon" title="Preview">üëÅÔ∏è</button>
                                    <button class="btn-icon delete" title="Delete">üóëÔ∏è</button>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <div class="title-cell">
                                    <div class="test-icon">üìú</div>
                                    <div>
                                        <strong>History Mock Test 1</strong>
                                        <div class="text-muted" style="font-size:0.75rem;">‡§á‡§§‡§ø‡§π‡§æ‡§∏ ‡§Æ‡•â‡§ï ‡§ü‡•á‡§∏‡•ç‡§ü 1</div>
                                    </div>
                                </div>
                            </td>
                            <td>History</td>
                            <td>75</td>
                            <td>90 min</td>
                            <td>32</td>
                            <td><span class="badge badge-new">Active</span></td>
                            <td>
                                <div class="actions">
                                    <button class="btn-icon" title="Edit">‚úèÔ∏è</button>
                                    <button class="btn-icon" title="Preview">üëÅÔ∏è</button>
                                    <button class="btn-icon delete" title="Delete">üóëÔ∏è</button>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <div class="title-cell">
                                    <div class="test-icon">üåç</div>
                                    <div>
                                        <strong>Geography Mock Test 1</strong>
                                        <div class="text-muted" style="font-size:0.75rem;">‡§≠‡•Ç‡§ó‡•ã‡§≤ ‡§Æ‡•â‡§ï ‡§ü‡•á‡§∏‡•ç‡§ü 1</div>
                                    </div>
                                </div>
                            </td>
                            <td>Geography</td>
                            <td>50</td>
                            <td>60 min</td>
                            <td>28</td>
                            <td><span class="badge badge-attempted">Draft</span></td>
                            <td>
                                <div class="actions">
                                    <button class="btn-icon" title="Edit">‚úèÔ∏è</button>
                                    <button class="btn-icon" title="Preview">üëÅÔ∏è</button>
                                    <button class="btn-icon delete" title="Delete">üóëÔ∏è</button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <!-- Create/Edit Test Modal -->
    <div class="modal" id="testModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Create New Mock Test</h2>
                <span class="modal-close" id="modalClose">&times;</span>
            </div>
            <div class="modal-body">
                <form id="testForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Test Name (English) *</label>
                            <input type="text" class="form-input" id="testNameEn" placeholder="e.g., Polity Mock Test 1"
                                required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Test Name (Hindi)</label>
                            <input type="text" class="form-input" id="testNameHi"
                                placeholder="e.g., ‡§∞‡§æ‡§ú‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ ‡§Æ‡•â‡§ï ‡§ü‡•á‡§∏‡•ç‡§ü 1">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Subject *</label>
                            <select class="form-select" id="testSubject" required>
                                <option value="">Select Subject</option>
                                <option value="polity">‚öñÔ∏è Indian Polity</option>
                                <option value="history">üìú History</option>
                                <option value="geography">üåç Geography</option>
                                <option value="economy">üìä Economy</option>
                                <option value="environment">üå± Environment</option>
                                <option value="science">üî¨ Science & Tech</option>
                                <option value="current">üì∞ Current Affairs</option>
                                <option value="culture">üé® Art & Culture</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Difficulty</label>
                            <select class="form-select" id="testDifficulty">
                                <option value="easy">Easy</option>
                                <option value="moderate" selected>Moderate</option>
                                <option value="difficult">Difficult</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Number of Questions *</label>
                            <input type="number" class="form-input" id="testQuestions" placeholder="100" min="1"
                                required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Time Limit (minutes) *</label>
                            <input type="number" class="form-input" id="testTime" placeholder="120" min="1" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Marking Scheme</label>
                        <div class="marking-scheme">
                            <div class="marking-item">
                                <label>Correct Answer:</label>
                                <input type="number" id="markCorrect" value="2" step="0.01">
                                <span>marks</span>
                            </div>
                            <div class="marking-item">
                                <label>Wrong Answer:</label>
                                <input type="number" id="markWrong" value="-0.66" step="0.01">
                                <span>marks</span>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Source <small>(optional)</small></label>
                        <input type="text" class="form-input" id="testSource" placeholder="e.g., Laxmikant Chapter 5">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Description <small>(optional)</small></label>
                        <textarea class="form-textarea" id="testDescription"
                            placeholder="Brief description of the test..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost" id="cancelBtn">Cancel</button>
                <button class="btn btn-primary" id="saveTestBtn">Save Test</button>
            </div>
        </div>
    </div>

    <!-- Import PDF Modal -->
    <div class="modal" id="importModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>üì• Import Questions from PDF</h2>
                <span class="modal-close" id="importModalClose">&times;</span>
            </div>
            <div class="modal-body">
                <!-- Step 1: Upload -->
                <div id="importStep1">
                    <div class="form-row" style="margin-bottom: 1.5rem;">
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label">Test Name *</label>
                            <input type="text" class="form-input" id="importTestName"
                                placeholder="e.g., Polity Mock Test 1" required>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label">Subject *</label>
                            <select class="form-select" id="importSubject">
                                <option value="Polity">‚öñÔ∏è Indian Polity</option>
                                <option value="History">üìú History</option>
                                <option value="Geography">üåç Geography</option>
                                <option value="Economy">üìä Economy</option>
                                <option value="Environment">üå± Environment</option>
                                <option value="Science">üî¨ Science & Tech</option>
                                <option value="Current Affairs">üì∞ Current Affairs</option>
                                <option value="Culture">üé® Art & Culture</option>
                            </select>
                        </div>
                    </div>

                    <div class="import-section" id="dropZone"
                        style="border: 2px dashed var(--border-color); border-radius: 1rem; padding: 2rem; text-align: center; cursor: pointer; transition: all 0.3s;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üìÑ</div>
                        <h3>Drop PDF file here</h3>
                        <p style="color: var(--text-muted);">or click to browse</p>
                        <input type="file" id="pdfInput" accept=".pdf,.json" style="display: none;">
                    </div>

                    <div id="extractionProgress" style="display: none; text-align: center; padding: 2rem;">
                        <div style="font-size: 2rem; animation: spin 1s linear infinite;">‚è≥</div>
                        <p style="margin-top: 1rem;">Extracting questions from PDF...</p>
                    </div>

                    <style>
                        @keyframes spin {
                            from {
                                transform: rotate(0deg);
                            }

                            to {
                                transform: rotate(360deg);
                            }
                        }

                        #dropZone.dragover {
                            border-color: var(--primary-500);
                            background: rgba(59, 130, 246, 0.1);
                        }
                    </style>

                    <div class="form-group mt-xl">
                        <label class="form-label">Or paste JSON data directly:</label>
                        <textarea class="form-textarea" id="jsonInput" placeholder='Paste JSON output here...'
                            style="min-height: 120px; font-family: monospace;"></textarea>
                    </div>
                </div>

                <div id="importStep2" style="display: none;">
                    <div id="extractionSuccess"
                        style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 0.75rem; padding: 1rem; margin-bottom: 1.5rem;">
                        <h3 style="color: #22c55e; margin-bottom: 0.5rem;">‚úÖ Extraction Complete!</h3>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-top: 1rem;">
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary-400);"
                                    id="statTotal">0</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">Questions Found</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #22c55e;" id="statWithAnswers">0
                                </div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">With Answers</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #f59e0b;" id="statMissing">0
                                </div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">Missing Answers</div>
                            </div>
                        </div>
                    </div>

                    <!-- Debug panel when 0 questions -->
                    <div id="debugPanel"
                        style="display: none; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 0.75rem; padding: 1rem; margin-bottom: 1.5rem;">
                        <h3 style="color: #ef4444; margin-bottom: 0.5rem;">‚ö†Ô∏è No Questions Detected</h3>
                        <p style="color: var(--text-muted); font-size: 0.875rem; margin-bottom: 1rem;">
                            The PDF format might not be recognized. Here's the extracted text:
                        </p>
                        <textarea id="debugText" readonly
                            style="width: 100%; height: 150px; font-family: monospace; font-size: 0.75rem; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 0.5rem; padding: 0.75rem; color: var(--text-secondary);"></textarea>
                        <p style="color: var(--text-muted); font-size: 0.75rem; margin-top: 0.75rem;">
                            üí° <strong>Tip:</strong> Try using the Python tool for complex PDFs:<br>
                            <code
                                style="background: var(--bg-tertiary); padding: 0.25rem 0.5rem; border-radius: 0.25rem;">python tools/extract_mcq.py yourfile.pdf output.json</code>
                        </p>
                    </div>

                    <div
                        style="max-height: 300px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 0.75rem;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead style="position: sticky; top: 0; background: var(--bg-secondary);">
                                <tr>
                                    <th
                                        style="padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--border-color);">
                                        #</th>
                                    <th
                                        style="padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--border-color);">
                                        Question</th>
                                    <th
                                        style="padding: 0.75rem; text-align: center; border-bottom: 1px solid var(--border-color);">
                                        Answer</th>
                                </tr>
                            </thead>
                            <tbody id="previewTableBody">
                            </tbody>
                        </table>
                    </div>

                    <button class="btn btn-ghost" id="backToUpload" style="margin-top: 1rem;">
                        ‚Üê Back to Upload
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost" id="cancelImportBtn">Cancel</button>
                <button class="btn btn-primary" id="confirmImportBtn" disabled>üì• Import Questions</button>
            </div>
        </div>
    </div>

    <!-- Access Keys Modal -->
    <div class="modal" id="keysModal">
        <div class="modal-content" style="max-width: 550px;">
            <div class="modal-header">
                <h2>üîë Access Keys Management</h2>
                <span class="modal-close" id="keysModalClose">&times;</span>
            </div>
            <div class="modal-body">
                <div
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color);">
                    <div>
                        <h3 style="margin-bottom: 0.25rem;">Generate Access Keys</h3>
                        <p style="color: var(--text-muted); font-size: 0.875rem;">Each key grants 3 days of access</p>
                    </div>
                    <button class="btn btn-primary" id="generateKeyBtn">
                        ‚ûï Generate New Key
                    </button>
                </div>

                <div id="keysList">
                    <!-- Keys will be rendered here -->
                </div>

                <div
                    style="margin-top: 1.5rem; padding: 1rem; background: rgba(59, 130, 246, 0.1); border-radius: 0.75rem; border-left: 4px solid #3b82f6;">
                    <h4 style="color: #60a5fa; margin-bottom: 0.5rem;">üí° How it works</h4>
                    <ul style="color: var(--text-secondary); font-size: 0.875rem; margin: 0; padding-left: 1.25rem;">
                        <li>Generate a key and share it with users</li>
                        <li>Users enter the key on the login page</li>
                        <li>Access is granted for 3 days automatically</li>
                        <li>Same key can be reused after session expires</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Mock Tests Modal -->
    <div class="modal" id="testsModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>üìù Mock Tests</h2>
                <span class="modal-close" id="testsModalClose">&times;</span>
            </div>
            <div class="modal-body">
                <div id="testsModalList" style="max-height: 500px; overflow-y: auto;">
                    <!-- Populated dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Questions Modal -->
    <div class="modal" id="questionsModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>‚ùì Questions Bank</h2>
                <span class="modal-close" id="questionsModalClose">&times;</span>
            </div>
            <div class="modal-body">
                <div id="questionsModalList" style="max-height: 500px; overflow-y: auto;">
                    <!-- Populated dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Subjects Modal (placeholder) -->
    <div class="modal" id="subjectsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìö Subjects</h2>
                <span class="modal-close" id="subjectsModalClose">&times;</span>
            </div>
            <div class="modal-body">
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                    <div class="card card-sm" style="text-align: center;">
                        <span style="font-size: 2rem;">‚öñÔ∏è</span>
                        <p style="font-weight: 600; margin-top: 0.5rem;">Indian Polity</p>
                    </div>
                    <div class="card card-sm" style="text-align: center;">
                        <span style="font-size: 2rem;">üìú</span>
                        <p style="font-weight: 600; margin-top: 0.5rem;">History</p>
                    </div>
                    <div class="card card-sm" style="text-align: center;">
                        <span style="font-size: 2rem;">üåç</span>
                        <p style="font-weight: 600; margin-top: 0.5rem;">Geography</p>
                    </div>
                    <div class="card card-sm" style="text-align: center;">
                        <span style="font-size: 2rem;">üìä</span>
                        <p style="font-weight: 600; margin-top: 0.5rem;">Economy</p>
                    </div>
                    <div class="card card-sm" style="text-align: center;">
                        <span style="font-size: 2rem;">üå±</span>
                        <p style="font-weight: 600; margin-top: 0.5rem;">Environment</p>
                    </div>
                    <div class="card card-sm" style="text-align: center;">
                        <span style="font-size: 2rem;">üî¨</span>
                        <p style="font-weight: 600; margin-top: 0.5rem;">Science & Tech</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Users Modal (placeholder) -->
    <div class="modal" id="usersModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üë• Users</h2>
                <span class="modal-close" id="usersModalClose">&times;</span>
            </div>
            <div class="modal-body">
                <p style="text-align: center; color: var(--text-muted); padding: 2rem;">
                    User management coming soon!<br>
                    <small>This will show all users who have accessed the platform.</small>
                </p>
            </div>
        </div>
    </div>

    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/supabase-config.js"></script>

    <!-- Admin Data Manager -->
    <script src="../js/admin-data.js"></script>

    <!-- PDF.js Library for PDF extraction -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <script src="../js/pdf-extractor.js"></script>

    <script>
        // Modal Handlers
        const testModal = document.getElementById('testModal');
        const importModal = document.getElementById('importModal');
        const testsModal = document.getElementById('testsModal');
        const questionsModal = document.getElementById('questionsModal');
        const subjectsModal = document.getElementById('subjectsModal');
        const usersModal = document.getElementById('usersModal');

        // Create Test
        document.getElementById('createTestBtn').addEventListener('click', () => {
            testModal.classList.add('active');
        });

        document.getElementById('modalClose').addEventListener('click', () => {
            testModal.classList.remove('active');
        });

        document.getElementById('cancelBtn').addEventListener('click', () => {
            testModal.classList.remove('active');
        });

        // Import PDF
        document.getElementById('importPdfBtn').addEventListener('click', () => {
            importModal.classList.add('active');
        });

        document.getElementById('navImport').addEventListener('click', (e) => {
            e.preventDefault();
            importModal.classList.add('active');
        });

        document.getElementById('importModalClose').addEventListener('click', () => {
            importModal.classList.remove('active');
        });

        document.getElementById('cancelImportBtn').addEventListener('click', () => {
            importModal.classList.remove('active');
        });

        // Mock Tests nav
        document.getElementById('navTests').addEventListener('click', (e) => {
            e.preventDefault();
            renderTestsModalContent();
            testsModal.classList.add('active');
        });
        document.getElementById('testsModalClose').addEventListener('click', () => {
            testsModal.classList.remove('active');
        });

        // Render tests in modal
        function renderTestsModalContent() {
            const container = document.getElementById('testsModalList');
            const tests = adminData.getAllTests();

            if (tests.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: var(--text-muted);">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üìù</div>
                        <p>No tests created yet.</p>
                        <button class="btn btn-primary" style="margin-top: 1rem;" onclick="testsModal.classList.remove('active'); document.getElementById('createTestBtn').click();">
                            + Create First Test
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = tests.map(test => {
                const subject = adminData.getSubjectByValue(test.subject_id) || { icon: 'üìù', name_en: test.subject_id };
                const qCount = adminData.getQuestionsByTestId(test.id).length;
                return `
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: var(--bg-tertiary); border-radius: 0.75rem; margin-bottom: 0.75rem;">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <span style="font-size: 2rem;">${subject.icon}</span>
                            <div>
                                <div style="font-weight: 600;">${test.name_en}</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">
                                    ${subject.name_en} ‚Ä¢ ${qCount} questions ‚Ä¢ ${test.time_limit} min
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-sm btn-outline" onclick="viewTestQuestions('${test.id}')">View Questions</button>
                            <button class="btn btn-sm btn-ghost" style="color: var(--error-500);" onclick="deleteTest('${test.id}')">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Questions nav
        document.getElementById('navQuestions').addEventListener('click', (e) => {
            e.preventDefault();
            renderQuestionsModalContent();
            questionsModal.classList.add('active');
        });
        document.getElementById('questionsModalClose').addEventListener('click', () => {
            questionsModal.classList.remove('active');
        });

        // Render questions in modal
        function renderQuestionsModalContent() {
            const container = document.getElementById('questionsModalList');
            const tests = adminData.getAllTests();
            let totalQuestions = 0;

            let html = '';

            tests.forEach(test => {
                const questions = adminData.getQuestionsByTestId(test.id);
                totalQuestions += questions.length;
                const subject = adminData.getSubjectByValue(test.subject_id) || { icon: 'üìù', name_en: test.subject_id };

                if (questions.length > 0) {
                    html += `
                        <div style="margin-bottom: 1.5rem;">
                            <h4 style="margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                                <span>${subject.icon}</span> ${test.name_en} 
                                <span style="font-size: 0.75rem; color: var(--text-muted); font-weight: normal;">(${questions.length} questions)</span>
                            </h4>
                            ${questions.slice(0, 5).map((q, i) => `
                                <div style="padding: 0.75rem; background: var(--bg-tertiary); border-radius: 0.5rem; margin-bottom: 0.5rem; font-size: 0.875rem;">
                                    <strong>Q${q.question_number}:</strong> ${(q.question_text_en || '').substring(0, 100)}${(q.question_text_en || '').length > 100 ? '...' : ''}
                                    <span style="color: #22c55e; margin-left: 0.5rem;">Answer: ${(q.correct_option || 'a').toUpperCase()}</span>
                                </div>
                            `).join('')}
                            ${questions.length > 5 ? `<p style="font-size: 0.75rem; color: var(--text-muted); text-align: center;">... and ${questions.length - 5} more questions</p>` : ''}
                        </div>
                    `;
                }
            });

            if (totalQuestions === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: var(--text-muted);">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">‚ùì</div>
                        <p>No questions added yet.</p>
                        <button class="btn btn-primary" style="margin-top: 1rem;" onclick="questionsModal.classList.remove('active'); document.getElementById('navImport').click();">
                            üì• Import Questions
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div style="padding: 0.75rem 1rem; background: var(--primary-500); color: white; border-radius: 0.5rem; margin-bottom: 1rem; text-align: center;">
                    üìä Total: ${totalQuestions} questions across ${tests.length} tests
                </div>
                ${html}
            `;
        }

        // View test questions
        function viewTestQuestions(testId) {
            testsModal.classList.remove('active');
            const questions = adminData.getQuestionsByTestId(testId);
            const test = adminData.getTestById(testId);

            alert(`üìù ${test.name_en}\n\n${questions.length} questions\n\nFull question viewer coming soon!`);
        }
        window.viewTestQuestions = viewTestQuestions;

        // Subjects nav
        document.getElementById('navSubjects').addEventListener('click', (e) => {
            e.preventDefault();
            subjectsModal.classList.add('active');
        });
        document.getElementById('subjectsModalClose').addEventListener('click', () => {
            subjectsModal.classList.remove('active');
        });

        // Users nav
        document.getElementById('navUsers').addEventListener('click', (e) => {
            e.preventDefault();
            usersModal.classList.add('active');
        });
        document.getElementById('usersModalClose').addEventListener('click', () => {
            usersModal.classList.remove('active');
        });

        // Drag and Drop
        const dropZone = document.getElementById('dropZone');
        const pdfInput = document.getElementById('pdfInput');

        dropZone.addEventListener('click', () => pdfInput.click());

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            handleFile(file);
        });

        pdfInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            handleFile(file);
        });

        // PDF Extractor instance
        let pdfExtractor = null;

        async function handleFile(file) {
            if (!file) return;

            const testName = document.getElementById('importTestName').value || 'Imported Test';
            const subject = document.getElementById('importSubject').value || 'General';

            if (file.name.endsWith('.json')) {
                // Read JSON file
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        showImportPreview(data);
                    } catch (err) {
                        alert('Invalid JSON file');
                    }
                };
                reader.readAsText(file);
            } else if (file.name.endsWith('.pdf')) {
                // Browser-based PDF extraction
                document.getElementById('dropZone').style.display = 'none';
                document.getElementById('extractionProgress').style.display = 'block';

                try {
                    pdfExtractor = new PDFQuestionExtractor();
                    await pdfExtractor.extractText(file);
                    pdfExtractor.parseQuestions(pdfExtractor.rawText);

                    const data = pdfExtractor.toJSON(testName, subject);
                    const summary = pdfExtractor.getSummary();

                    // Show preview with raw text for debug
                    showImportPreview(data, summary, pdfExtractor.rawText);

                } catch (err) {
                    console.error('PDF extraction error:', err);
                    alert('‚ùå Error extracting PDF: ' + err.message + '\n\nTry using the Python tool instead.');
                    document.getElementById('dropZone').style.display = 'block';
                    document.getElementById('extractionProgress').style.display = 'none';
                }
            }
        }

        // JSON paste handler
        document.getElementById('jsonInput').addEventListener('input', (e) => {
            try {
                const data = JSON.parse(e.target.value);
                showImportPreview(data);
            } catch (err) {
                document.getElementById('importStep2').style.display = 'none';
                document.getElementById('confirmImportBtn').disabled = true;
            }
        });

        function showImportPreview(data, summary = null, rawText = '') {
            // Hide step 1, show step 2
            document.getElementById('importStep1').style.display = 'none';
            document.getElementById('importStep2').style.display = 'block';
            document.getElementById('extractionProgress').style.display = 'none';

            // Update stats
            const total = data.total_questions || (data.questions ? data.questions.length : 0);
            document.getElementById('statTotal').textContent = total;

            if (summary) {
                document.getElementById('statWithAnswers').textContent = summary.withAnswers;
                document.getElementById('statMissing').textContent = summary.missingAnswers;
            } else {
                document.getElementById('statWithAnswers').textContent = total;
                document.getElementById('statMissing').textContent = '0';
            }

            // Show debug panel if 0 questions
            const debugPanel = document.getElementById('debugPanel');
            const successPanel = document.getElementById('extractionSuccess');

            if (total === 0) {
                debugPanel.style.display = 'block';
                successPanel.style.display = 'none';
                document.getElementById('debugText').value = rawText || 'No text extracted from PDF';
                document.getElementById('confirmImportBtn').disabled = true;
            } else {
                debugPanel.style.display = 'none';
                successPanel.style.display = 'block';
                document.getElementById('confirmImportBtn').disabled = false;
            }

            // Build preview table
            const tbody = document.getElementById('previewTableBody');
            tbody.innerHTML = '';

            const questions = data.questions || [];
            questions.slice(0, 50).forEach((q, i) => {
                const row = document.createElement('tr');
                const qText = (q.question_text_en || q.question || '').substring(0, 80);
                const answer = q.correct_option || q.answer || '-';
                row.innerHTML = `
                    <td style="padding: 0.5rem; border-bottom: 1px solid var(--border-color);">${q.question_number || i + 1}</td>
                    <td style="padding: 0.5rem; border-bottom: 1px solid var(--border-color);">${qText}${qText.length >= 80 ? '...' : ''}</td>
                    <td style="padding: 0.5rem; border-bottom: 1px solid var(--border-color); text-align: center; font-weight: 700; color: ${answer !== '-' ? '#22c55e' : '#f59e0b'};">${answer.toUpperCase()}</td>
                `;
                tbody.appendChild(row);
            });

            if (questions.length > 50) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="3" style="padding: 0.75rem; text-align: center; color: var(--text-muted);">... and ${questions.length - 50} more questions</td>`;
                tbody.appendChild(row);
            }

            window.importData = data;
        }

        // Back to upload
        document.getElementById('backToUpload').addEventListener('click', () => {
            document.getElementById('importStep1').style.display = 'block';
            document.getElementById('importStep2').style.display = 'none';
            document.getElementById('dropZone').style.display = 'block';
            document.getElementById('extractionProgress').style.display = 'none';
            document.getElementById('debugPanel').style.display = 'none';
            document.getElementById('extractionSuccess').style.display = 'block';
            document.getElementById('confirmImportBtn').disabled = true;
        });

        // Confirm import
        document.getElementById('confirmImportBtn').addEventListener('click', () => {
            if (window.importData) {
                // Save to adminData manager
                const newTest = adminData.importTestWithQuestions(window.importData);
                const count = window.importData.total_questions || window.importData.questions.length;

                // Update dashboard
                updateDashboardStats();
                refreshTestsTable();

                alert('‚úÖ Successfully imported "' + newTest.name_en + '" with ' + count + ' questions!');
                importModal.classList.remove('active');

                // Reset for next import
                document.getElementById('importStep1').style.display = 'block';
                document.getElementById('importStep2').style.display = 'none';
                document.getElementById('dropZone').style.display = 'block';
                document.getElementById('importTestName').value = '';
                document.getElementById('jsonInput').value = '';
                window.importData = null;
            }
        });

        // Save Test
        document.getElementById('saveTestBtn').addEventListener('click', () => {
            const form = document.getElementById('testForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const testData = {
                name_en: document.getElementById('testNameEn').value,
                name_hi: document.getElementById('testNameHi').value,
                subject: document.getElementById('testSubject').value,
                difficulty: document.getElementById('testDifficulty').value,
                questions: parseInt(document.getElementById('testQuestions').value) || 0,
                time: parseInt(document.getElementById('testTime').value) || 120,
                mark_correct: parseFloat(document.getElementById('markCorrect').value) || 2,
                mark_wrong: parseFloat(document.getElementById('markWrong').value) || 0.66,
                source: document.getElementById('testSource').value,
                description: document.getElementById('testDescription').value
            };

            // Save using adminData manager
            const newTest = adminData.createTest(testData);

            // Update stats on dashboard
            updateDashboardStats();
            refreshTestsTable();

            alert('‚úÖ Test "' + newTest.name_en + '" created successfully!');
            testModal.classList.remove('active');
            form.reset();
        });

        // Update dashboard stats
        function updateDashboardStats() {
            const stats = adminData.getStats();
            const statCards = document.querySelectorAll('.admin-stat-card .value');
            if (statCards.length >= 4) {
                statCards[0].textContent = stats.totalTests;
                statCards[1].textContent = stats.totalQuestions.toLocaleString();
                // statCards[2] = users (keep as is for now)
                statCards[3].textContent = stats.activeKeys;
            }
        }

        // Refresh tests table
        function refreshTestsTable() {
            const tbody = document.getElementById('testsTableBody');
            if (!tbody) return;

            const tests = adminData.getAllTests();

            if (tests.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 2rem; color: var(--text-muted);">
                            No tests created yet. Click "Create New Test" to get started.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = tests.map(test => {
                const subject = adminData.getSubjectByValue(test.subject_id) || { icon: 'üìù', name_en: test.subject_id };
                return `
                    <tr data-test-id="${test.id}">
                        <td>
                            <div class="title-cell">
                                <div class="test-icon">${subject.icon}</div>
                                <div>
                                    <strong>${test.name_en}</strong>
                                    ${test.name_hi ? `<div class="text-muted" style="font-size:0.75rem;">${test.name_hi}</div>` : ''}
                                </div>
                            </div>
                        </td>
                        <td>${subject.name_en}</td>
                        <td>${test.total_questions}</td>
                        <td>${test.time_limit} min</td>
                        <td>${test.attempts || 0}</td>
                        <td><span class="badge badge-new">${test.is_active ? 'Active' : 'Inactive'}</span></td>
                        <td>
                            <div class="actions">
                                <button class="btn-icon" title="Edit" onclick="editTest('${test.id}')">‚úèÔ∏è</button>
                                <button class="btn-icon" title="Add Questions" onclick="openAddQuestions('${test.id}')">‚ùì</button>
                                <button class="btn-icon delete" title="Delete" onclick="deleteTest('${test.id}')">üóëÔ∏è</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Delete test handler
        function deleteTest(testId) {
            const test = adminData.getTestById(testId);
            if (!test) return;

            if (confirm(`Delete test "${test.name_en}"?\n\nThis will also delete all associated questions.`)) {
                adminData.deleteTest(testId);
                updateDashboardStats();
                refreshTestsTable();
                alert('‚úÖ Test deleted successfully!');
            }
        }

        // Make delete function global
        window.deleteTest = deleteTest;
        window.editTest = (id) => alert('Edit feature coming soon! Test ID: ' + id);
        window.openAddQuestions = (id) => {
            document.getElementById('importTestName').value = adminData.getTestById(id)?.name_en || '';
            importModal.classList.add('active');
        };

        // Initialize on load
        updateDashboardStats();
        refreshTestsTable();

        // ===== ACCESS KEYS MANAGEMENT =====
        const keysModal = document.getElementById('keysModal');
        let generatedKeys = JSON.parse(localStorage.getItem('admin_keys') || '[]');

        // Open keys modal
        document.getElementById('navKeys').addEventListener('click', (e) => {
            e.preventDefault();
            renderKeysList();
            keysModal.classList.add('active');
        });

        document.getElementById('keysModalClose').addEventListener('click', () => {
            keysModal.classList.remove('active');
        });

        // Generate random key - use adminData manager
        function generateKey() {
            return adminData.generateKeyString();
        }

        // Generate new key
        document.getElementById('generateKeyBtn').addEventListener('click', () => {
            const newKey = adminData.createKey();

            // Also update legacy storage for backward compatibility
            generatedKeys.unshift({
                key: newKey.key,
                createdAt: newKey.created_at,
                validDays: 3,
                used: newKey.used,
                usedAt: newKey.used_at
            });
            localStorage.setItem('admin_keys', JSON.stringify(generatedKeys));

            updateDashboardStats();
            renderKeysList();

            alert('üîë New key generated: ' + newKey.key);
        });

        // Render keys list
        function renderKeysList() {
            const container = document.getElementById('keysList');
            const keys = adminData.getAllKeys();

            if (keys.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                        <p>No keys generated yet. Click "Generate New Key" to create one.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = keys.map(k => `
                <div class="key-item" style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: var(--bg-tertiary); border-radius: 0.75rem; margin-bottom: 0.75rem;">
                    <div>
                        <div style="font-family: 'JetBrains Mono', monospace; font-size: 1.125rem; font-weight: 600; color: ${k.used ? 'var(--text-muted)' : '#60a5fa'};">
                            ${k.key}
                        </div>
                        <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">
                            Created: ${new Date(k.created_at).toLocaleDateString()} ‚Ä¢ 
                            ${k.used ? '‚úì Used' : 'üü¢ Available'}
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-sm btn-outline" onclick="copyKey('${k.key}')" title="Copy">
                            üìã Copy
                        </button>
                        <button class="btn btn-sm btn-ghost" onclick="deleteKeyById('${k.id}')" title="Delete" style="color: var(--error-500);">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Copy key
        function copyKey(key) {
            navigator.clipboard.writeText(key).then(() => {
                alert('‚úÖ Key copied to clipboard: ' + key);
            });
        }

        // Delete key by ID
        function deleteKeyById(keyId) {
            if (confirm('Delete this key?')) {
                adminData.deleteKey(keyId);
                updateDashboardStats();
                renderKeysList();
            }
        }

        // Legacy delete by index (for backward compatibility)
        function deleteKey(index) {
            if (confirm('Delete this key?')) {
                generatedKeys.splice(index, 1);
                localStorage.setItem('admin_keys', JSON.stringify(generatedKeys));
                renderKeysList();
            }
        }

        // Close on overlay click
        [testModal, importModal, keysModal, testsModal, questionsModal, subjectsModal, usersModal].forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });

        // Close on Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                testModal.classList.remove('active');
                importModal.classList.remove('active');
                keysModal.classList.remove('active');
                testsModal.classList.remove('active');
                questionsModal.classList.remove('active');
                subjectsModal.classList.remove('active');
                usersModal.classList.remove('active');
            }
        });
    </script>
</body>

</html>