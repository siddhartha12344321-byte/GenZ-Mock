<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Results - GenZMocks</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* ===== SPEEDOMETER GAUGE ===== */
        .speedometer-container {
            position: relative;
            width: 280px;
            height: 180px;
            margin: 0 auto 1.5rem;
        }

        .speedometer {
            position: relative;
            width: 100%;
            height: 100%;
        }

        .speedometer-svg {
            width: 100%;
            height: 100%;
            overflow: visible;
        }

        .speedometer-bg {
            fill: none;
            stroke: #e5e7eb;
            stroke-width: 18;
            stroke-linecap: round;
        }

        .speedometer-progress {
            fill: none;
            stroke: url(#speedoGradient);
            stroke-width: 18;
            stroke-linecap: round;
            stroke-dasharray: 251;
            stroke-dashoffset: 251;
            transition: stroke-dashoffset 2s cubic-bezier(0.4, 0, 0.2, 1);
            filter: drop-shadow(0 0 8px rgba(59, 130, 246, 0.4));
        }

        .speedometer-ticks line {
            stroke: #9ca3af;
            stroke-width: 2;
        }

        .speedometer-tick-label {
            font-size: 10px;
            fill: #6b7280;
            font-weight: 500;
        }

        .speedometer-needle-container {
            position: absolute;
            bottom: 15px;
            left: 50%;
            width: 4px;
            height: 90px;
            transform-origin: bottom center;
            transform: translateX(-50%) rotate(-90deg);
            transition: transform 2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .speedometer-needle {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-bottom: 75px solid #ef4444;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }

        .speedometer-needle::after {
            content: '';
            position: absolute;
            bottom: -85px;
            left: 50%;
            transform: translateX(-50%);
            width: 18px;
            height: 18px;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.5);
            animation: pulse-glow 2s ease-in-out infinite;
        }

        .speedometer-center {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, #374151, #1f2937);
            border-radius: 50%;
            border: 3px solid #6b7280;
            z-index: 10;
        }

        .speedometer-value {
            position: absolute;
            bottom: 45px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
        }

        /* Glow effects based on score */
        .speedometer-container.excellent .speedometer-progress {
            filter: drop-shadow(0 0 15px rgba(34, 197, 94, 0.6));
        }

        .speedometer-container.good .speedometer-progress {
            filter: drop-shadow(0 0 12px rgba(59, 130, 246, 0.5));
        }

        .speedometer-container.average .speedometer-progress {
            filter: drop-shadow(0 0 10px rgba(245, 158, 11, 0.5));
        }

        .speedometer-container.poor .speedometer-progress {
            filter: drop-shadow(0 0 8px rgba(239, 68, 68, 0.5));
        }

        @keyframes pulse-glow {

            0%,
            100% {
                box-shadow: 0 0 8px rgba(239, 68, 68, 0.4);
            }

            50% {
                box-shadow: 0 0 18px rgba(239, 68, 68, 0.8);
            }
        }

        @keyframes countUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .stat-animate {
            animation: countUp 0.5s ease-out forwards;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">
    <!-- Header with Tabs - SuperKalam Style -->
    <header class="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-6">
            <div class="flex items-center justify-between py-4">
                <div class="flex items-center gap-8">
                    <!-- Page Title -->
                    <h1 class="text-orange-500 font-semibold py-2 px-1 border-b-2 border-orange-500">
                        Test Analysis
                    </h1>
                </div>

                <div class="flex items-center gap-4">
                    <!-- Attempt Selector -->
                    <select id="attemptSelect"
                        class="border border-gray-300 rounded-lg px-4 py-2 text-sm font-medium bg-white">
                        <option>1st Attempt</option>
                    </select>

                    <!-- View Answers Button - Direct link, no JS needed -->
                    <a id="viewAnswersBtn" href="answers.html"
                        class="flex items-center gap-2 px-4 py-2 text-orange-500 hover:text-orange-600 font-medium">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        View Answers
                    </a>
                    <script>
                        // Set View Answers link immediately
                        (function () {
                            const p = new URLSearchParams(window.location.search);
                            const link = document.getElementById('viewAnswersBtn');
                            if (link) link.href = 'answers.html?testId=' + (p.get('testId') || '') + '&attempt=' + (p.get('attempt') || 1);
                        })();
                    </script>

                    <!-- Go to Dashboard Button -->
                    <a href="student-dashboard.html"
                        class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                        </svg>
                        Go to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Main -->
    <main class="max-w-6xl mx-auto px-6 py-12">
        <div class="text-center mb-10">
            <div class="text-5xl mb-4">üéâ</div>
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Test Completed!</h1>
            <p class="text-gray-500" id="testInfo">Loading results...</p>
        </div>

        <div class="grid md:grid-cols-2 gap-8">
            <!-- Score Card -->
            <div class="bg-white rounded-2xl border border-gray-100 p-8 text-center">
                <!-- Animated Score Display with Circular Progress -->
                <div class="mb-6">
                    <div class="relative w-40 h-40 mx-auto">
                        <!-- SVG Circular Progress -->
                        <svg class="w-full h-full transform -rotate-90" viewBox="0 0 120 120">
                            <!-- Background Circle -->
                            <circle cx="60" cy="60" r="52" fill="none" stroke="#e5e7eb" stroke-width="12" />
                            <!-- Gradient Definition -->
                            <defs>
                                <linearGradient id="scoreGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" stop-color="#3b82f6" />
                                    <stop offset="50%" stop-color="#8b5cf6" />
                                    <stop offset="100%" stop-color="#06b6d4" />
                                </linearGradient>
                            </defs>
                            <!-- Progress Circle - Animated -->
                            <circle id="progressCircle" cx="60" cy="60" r="52" fill="none" stroke="url(#scoreGradient)"
                                stroke-width="12" stroke-linecap="round" stroke-dasharray="327" stroke-dashoffset="327"
                                style="transition: stroke-dashoffset 2s cubic-bezier(0.4, 0, 0.2, 1); filter: drop-shadow(0 0 8px rgba(139, 92, 246, 0.5));" />
                        </svg>
                        <!-- Score Text Overlay -->
                        <div class="absolute inset-0 flex flex-col items-center justify-center">
                            <div id="scoreDisplay"
                                class="text-4xl font-bold bg-gradient-to-r from-blue-600 via-purple-600 to-cyan-500 bg-clip-text text-transparent">
                                0</div>
                            <div class="text-gray-400 text-xs font-semibold tracking-wider">MARKS</div>
                        </div>
                    </div>
                    <!-- Accuracy below -->
                    <div class="mt-4">
                        <span id="scorePercent" class="text-2xl font-bold text-gray-700">0%</span>
                        <span class="text-gray-500 text-sm ml-1">accuracy</span>
                    </div>
                </div>

                <div id="scoreMessage" class="text-xl font-semibold text-green-600 mb-6">Excellent!</div>

                <div class="grid grid-cols-3 gap-4 mb-6">
                    <div class="bg-green-50 rounded-xl p-4 stat-animate" style="animation-delay: 0.2s">
                        <div id="correctCount" class="text-2xl font-bold text-green-600">0</div>
                        <div class="text-sm text-gray-500">Correct</div>
                    </div>
                    <div class="bg-red-50 rounded-xl p-4 stat-animate" style="animation-delay: 0.3s">
                        <div id="wrongCount" class="text-2xl font-bold text-red-600">0</div>
                        <div class="text-sm text-gray-500">Wrong</div>
                    </div>
                    <div class="bg-gray-50 rounded-xl p-4 stat-animate" style="animation-delay: 0.4s">
                        <div id="skippedCount" class="text-2xl font-bold text-gray-500">0</div>
                        <div class="text-sm text-gray-500">Skipped</div>
                    </div>
                </div>

                <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl p-4 mb-6">
                    <div class="flex justify-between items-center">
                        <span class="font-medium">UPSC Score (200 Marks)</span>
                        <span id="upscScore" class="text-2xl font-bold">0</span>
                    </div>
                    <div id="upscBreakdown" class="text-sm opacity-90 mt-1 text-left">Loading...</div>
                </div>

                <div class="flex gap-4 justify-center flex-wrap">
                    <a id="retakeBtn" href="#"
                        class="px-6 py-3 bg-gray-100 text-gray-700 rounded-xl font-medium hover:bg-gray-200 transition-colors">
                        üîÑ Retake Test
                    </a>
                    <a href="student-dashboard.html"
                        class="px-6 py-3 bg-blue-600 text-white rounded-xl font-medium hover:bg-blue-700 transition-colors">
                        üìö More Tests
                    </a>
                </div>
            </div>

            <!-- Leaderboard Card (Replaces Performance Analysis) -->
            <div class="bg-white rounded-2xl border border-gray-100 p-8">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-gray-900 flex items-center gap-2">
                        üèÜ Leaderboard
                        <span id="leaderboardTestName" class="text-sm font-normal text-gray-500"></span>
                    </h2>
                    <button onclick="loadLeaderboard()"
                        class="text-blue-600 hover:text-blue-700 text-sm font-medium flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                        Refresh
                    </button>
                </div>

                <!-- Quick Stats - Your Performance -->
                <div class="grid grid-cols-2 gap-6 mb-6 pb-6 border-b border-gray-100">
                    <div class="text-center bg-gradient-to-br from-orange-50 to-amber-50 rounded-xl p-4">
                        <div id="rank"
                            class="text-3xl font-bold bg-gradient-to-r from-orange-500 to-amber-500 bg-clip-text text-transparent">
                            #--</div>
                        <div class="text-sm text-gray-600 font-medium">Your Rank</div>
                    </div>
                    <div class="text-center bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl p-4">
                        <div id="accuracy"
                            class="text-3xl font-bold bg-gradient-to-r from-green-500 to-emerald-500 bg-clip-text text-transparent">
                            0%</div>
                        <div class="text-sm text-gray-600 font-medium">Accuracy</div>
                    </div>
                </div>

                <!-- Leaderboard List -->
                <div id="leaderboardContent" class="space-y-2 max-h-[400px] overflow-y-auto">
                    <div class="flex items-center justify-center py-8 text-gray-500">
                        <svg class="animate-spin h-6 w-6 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none"
                            viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                            </circle>
                            <path class="opacity-75" fill="currentColor"
                                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                            </path>
                        </svg>
                        Loading leaderboard...
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="js/firebase-sync.js"></script>
    <script src="js/admin-data.js"></script>
    <script>
        // Get results from URL
        const params = new URLSearchParams(window.location.search);
        const testId = params.get('testId') || '';
        const attemptNum = parseInt(params.get('attempt')) || 0; // 0 = new submission, 1+ = viewing saved

        let correct, wrong, total, timeTaken, percentage, upscScore, accuracy, skipped;
        let isNewAttempt = false;

        // Check if viewing saved attempt or new submission
        if (attemptNum > 0 && testId) {
            // Load from localStorage
            const testAttempts = JSON.parse(localStorage.getItem('test_attempts') || '{}');
            const attempts = testAttempts[testId] || [];
            const attemptData = attempts[attemptNum - 1]; // 0-indexed

            if (attemptData) {
                correct = attemptData.correct;
                wrong = attemptData.wrong;
                total = attemptData.total;
                timeTaken = attemptData.time;
                percentage = attemptData.percentage;
            } else {
                correct = 0; wrong = 0; total = 0; timeTaken = 0; percentage = 0;
            }
        } else {
            // New submission - get from URL params
            correct = parseInt(params.get('correct')) || 0;
            wrong = parseInt(params.get('wrong')) || 0;
            total = parseInt(params.get('total')) || 0;
            timeTaken = parseInt(params.get('time')) || 0;
            percentage = total > 0 ? Math.round((correct / total) * 100) : 0;
            isNewAttempt = correct > 0 || wrong > 0 || total > 0; // Has URL data = new submission
        }

        skipped = total - correct - wrong;
        upscScore = (correct * 2) - (wrong * 0.66);
        accuracy = (correct + wrong) > 0 ? Math.round((correct / (correct + wrong)) * 100) : 0;

        // Save attempt to localStorage with full details
        function saveAttempt() {
            // Get existing attempts structure
            let testAttempts = JSON.parse(localStorage.getItem('test_attempts') || '{}');

            if (testId) {
                // Initialize array for this test if not exists
                if (!testAttempts[testId]) {
                    testAttempts[testId] = [];
                }

                // Check if max 5 attempts reached
                if (testAttempts[testId].length < 5) {
                    const attemptNumber = testAttempts[testId].length + 1;
                    testAttempts[testId].push({
                        attempt: attemptNumber,
                        correct: correct,
                        wrong: wrong,
                        total: total,
                        time: timeTaken,
                        percentage: percentage,
                        date: new Date().toISOString()
                    });
                    localStorage.setItem('test_attempts', JSON.stringify(testAttempts));
                }

                // Also update attempted_tests for backward compatibility
                let attemptedTests = JSON.parse(localStorage.getItem('attempted_tests') || '[]');
                if (!attemptedTests.includes(testId)) {
                    attemptedTests.push(testId);
                    localStorage.setItem('attempted_tests', JSON.stringify(attemptedTests));
                }
            }

            // Update user progress
            let progress = JSON.parse(localStorage.getItem('user_progress') || '{"tests":0,"correct":0,"total":0,"time":0}');
            progress.tests++;
            progress.correct += correct;
            progress.total += total;
            progress.time += Math.round(timeTaken / 60);
            localStorage.setItem('user_progress', JSON.stringify(progress));

            // Record activity for streak tracking
            const today = new Date().toISOString().split('T')[0];
            let streakData = JSON.parse(localStorage.getItem('streak_data') || '{"currentStreak":0,"lastActivityDate":null,"weeklyDays":[]}');

            if (streakData.lastActivityDate !== today) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toISOString().split('T')[0];

                if (streakData.lastActivityDate === yesterdayStr) {
                    streakData.currentStreak++;
                } else if (!streakData.lastActivityDate) {
                    streakData.currentStreak = 1;
                } else {
                    streakData.currentStreak = 1;
                }

                streakData.lastActivityDate = today;

                if (!streakData.weeklyDays.includes(today)) {
                    streakData.weeklyDays.push(today);
                    const sevenDaysAgo = new Date();
                    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                    streakData.weeklyDays = streakData.weeklyDays.filter(d => new Date(d) >= sevenDaysAgo);
                }

                localStorage.setItem('streak_data', JSON.stringify(streakData));
            }
        }

        // Animate speedometer
        function animateScore() {
            // Safe percentage value - prevent NaN
            const safePercent = (typeof percentage === 'number' && !isNaN(percentage)) ? percentage : 0;

            const speedoProgress = document.getElementById('speedoProgress');
            const speedoNeedle = document.getElementById('speedoNeedle');
            const speedoContainer = document.getElementById('speedometerContainer');

            // Calculate arc length - semicircle with radius 80: œÄ * r = 251.33
            const arcLength = Math.PI * 80;
            const targetOffset = arcLength - (safePercent / 100) * arcLength;

            // Calculate needle rotation - starts at -90deg (left), ends at 90deg (right)
            const targetRotation = -90 + (safePercent / 100) * 180;

            // Add performance class based on score
            if (safePercent >= 80) {
                speedoContainer.classList.add('excellent');
            } else if (safePercent >= 60) {
                speedoContainer.classList.add('good');
            } else if (safePercent >= 40) {
                speedoContainer.classList.add('average');
            } else {
                speedoContainer.classList.add('poor');
            }

            // Animate after a short delay
            setTimeout(() => {
                // Animate the arc
                speedoProgress.style.strokeDasharray = arcLength;
                speedoProgress.style.strokeDashoffset = targetOffset;

                // Animate the needle
                speedoNeedle.style.transform = `translateX(-50%) rotate(${targetRotation}deg)`;
            }, 300);

            // Animate percentage counter with easing
            if (safePercent === 0) {
                document.getElementById('scorePercent').textContent = '0%';
                return;
            }

            const duration = 2000;
            const startTime = performance.now();

            function easeOutCubic(t) {
                return 1 - Math.pow(1 - t, 3);
            }

            function animateNumber(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const easedProgress = easeOutCubic(progress);
                const current = Math.round(safePercent * easedProgress);

                document.getElementById('scorePercent').textContent = current + '%';

                if (progress < 1) {
                    requestAnimationFrame(animateNumber);
                }
            }

            requestAnimationFrame(animateNumber);
        }

        // Update UI
        function updateUI() {
            // Get test name
            const tests = adminData?.getAllTests() || [];
            const test = tests.find(t => t.id === testId);
            document.getElementById('testInfo').textContent = (test?.name_en || 'Mock Test') + ' ‚Ä¢ Completed just now';
            document.getElementById('retakeBtn').href = `test-oliveboard.html?id=${testId}`;

            // Stats - with safe number conversions
            const safeCorrect = (typeof correct === 'number' && !isNaN(correct)) ? correct : 0;
            const safeWrong = (typeof wrong === 'number' && !isNaN(wrong)) ? wrong : 0;
            const safeSkipped = (typeof skipped === 'number' && !isNaN(skipped)) ? skipped : 0;
            const safePercentage = (typeof percentage === 'number' && !isNaN(percentage)) ? percentage : 0;
            const safeAccuracy = (typeof accuracy === 'number' && !isNaN(accuracy)) ? accuracy : 0;
            const safeUpscScore = (typeof upscScore === 'number' && !isNaN(upscScore)) ? upscScore : 0;

            document.getElementById('correctCount').textContent = safeCorrect;
            document.getElementById('wrongCount').textContent = safeWrong;
            document.getElementById('skippedCount').textContent = safeSkipped;

            // Animate the circular progress gauge
            const progressCircle = document.getElementById('progressCircle');
            if (progressCircle) {
                // Circle circumference = 2 * œÄ * r = 2 * 3.14159 * 52 = 327
                const circumference = 327;
                const progressPercent = Math.min(safeAccuracy, 100); // Cap at 100%
                const offset = circumference - (circumference * progressPercent / 100);

                // Trigger animation after a small delay
                setTimeout(() => {
                    progressCircle.style.strokeDashoffset = offset;
                }, 100);
            }

            // Animate score number counting up
            const scoreDisplayEl = document.getElementById('scoreDisplay');
            if (scoreDisplayEl) {
                animateValue(scoreDisplayEl, 0, safeUpscScore, 2000);
            }

            // Display accuracy percentage with animation
            const scorePercentEl = document.getElementById('scorePercent');
            if (scorePercentEl) {
                animateValueInt(scorePercentEl, 0, safeAccuracy, 2000, '%');
            }

            document.getElementById('upscScore').textContent = safeUpscScore.toFixed(1);
            document.getElementById('upscBreakdown').textContent = `(+2 √ó ${safeCorrect}) - (0.66 √ó ${safeWrong}) = ${safeUpscScore.toFixed(1)} marks`;


            // Accuracy
            document.getElementById('accuracy').textContent = safeAccuracy + '%';

            // Score message
            const msgEl = document.getElementById('scoreMessage');
            if (percentage >= 80) {
                msgEl.textContent = 'üèÜ Excellent! You\'re ready!';
                msgEl.className = 'text-xl font-semibold text-green-600 mb-6';
            } else if (percentage >= 60) {
                msgEl.textContent = 'üëç Good Job!';
                msgEl.className = 'text-xl font-semibold text-blue-600 mb-6';
            } else if (percentage >= 40) {
                msgEl.textContent = 'üìö Keep Practicing!';
                msgEl.className = 'text-xl font-semibold text-yellow-600 mb-6';
            } else {
                msgEl.textContent = 'üí™ Need More Practice';
                msgEl.className = 'text-xl font-semibold text-red-600 mb-6';
            }

            // Rank will be set by loadLeaderboard()
            document.getElementById('rank').textContent = '#--';
        }

        // Animate float value (for UPSC marks) - smooth counting effect
        function animateValue(el, start, end, duration) {
            const startTime = performance.now();
            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const eased = 1 - Math.pow(1 - progress, 3); // ease out cubic
                const current = start + (end - start) * eased;
                el.textContent = current.toFixed(1);
                if (progress < 1) requestAnimationFrame(update);
            }
            requestAnimationFrame(update);
        }

        // Animate integer value (for percentages)
        function animateValueInt(el, start, end, duration, suffix = '') {
            const startTime = performance.now();
            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const eased = 1 - Math.pow(1 - progress, 3);
                const current = Math.round(start + (end - start) * eased);
                el.textContent = current + suffix;
                if (progress < 1) requestAnimationFrame(update);
            }
            requestAnimationFrame(update);
        }

        // Get current user info
        function getCurrentUser() {
            const userData = JSON.parse(localStorage.getItem('user_data') || '{}');
            return {
                name: userData.name || 'Anonymous',
                key: userData.key || ''
            };
        }

        // Save result to Firebase
        async function saveResultToFirebase() {
            if (!window.FirebaseSync || !testId) return;

            const user = getCurrentUser();
            const resultData = {
                userName: user.name,
                userKey: user.key,
                correct: correct,
                wrong: wrong,
                total: total,
                score: upscScore,
                accuracy: accuracy,
                timeTaken: timeTaken
            };

            try {
                await FirebaseSync.saveTestResult(testId, resultData);
                console.log('‚úÖ Result saved to Firebase');
            } catch (e) {
                console.error('Failed to save result to Firebase:', e);
            }
        }

        // Load and display leaderboard with premium design
        async function loadLeaderboard() {
            const container = document.getElementById('leaderboardContent');
            const testNameEl = document.getElementById('leaderboardTestName');
            const currentUser = getCurrentUser();

            if (!testId) {
                container.innerHTML = '<div class="text-center py-6 text-gray-500">No test selected</div>';
                return;
            }

            // Show premium loading animation
            container.innerHTML = `
                <div class="flex flex-col items-center justify-center py-10">
                    <div class="relative w-16 h-16 mb-4">
                        <div class="absolute inset-0 rounded-full border-4 border-orange-200"></div>
                        <div class="absolute inset-0 rounded-full border-4 border-orange-500 border-t-transparent animate-spin"></div>
                        <div class="absolute inset-2 rounded-full bg-gradient-to-br from-orange-100 to-amber-50 flex items-center justify-center">
                            <span class="text-xl">üèÜ</span>
                        </div>
                    </div>
                    <div class="text-gray-600 font-medium">Loading rankings...</div>
                </div>
            `;

            // Get test name
            const tests = adminData?.getAllTests() || [];
            const test = tests.find(t => t.id === testId);
            testNameEl.textContent = test ? `- ${test.name_en}` : '';

            // Build leaderboard data - try Firebase first, fallback to current user
            let leaderboard = [];

            try {
                if (window.FirebaseSync) {
                    leaderboard = await FirebaseSync.getTestLeaderboard(testId) || [];
                }
            } catch (e) {
                console.error('Firebase leaderboard fetch failed:', e);
            }

            // If no Firebase data, show current user as #1 (they just completed the test)
            if (leaderboard.length === 0 && (correct > 0 || total > 0)) {
                leaderboard = [{
                    rank: 1,
                    userName: currentUser.name || 'You',
                    userKey: currentUser.key,
                    correct: correct,
                    wrong: wrong,
                    total: total,
                    score: upscScore,
                    accuracy: accuracy
                }];
            }

            // Find current user's rank and update display
            const userEntry = leaderboard.find(r => r.userName === currentUser.name || r.userKey === currentUser.key);
            if (userEntry) {
                document.getElementById('rank').textContent = '#' + userEntry.rank;
            } else if (leaderboard.length === 0) {
                document.getElementById('rank').textContent = '#1';
            }

            // Render the leaderboard
            if (leaderboard.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-10">
                        <div class="w-20 h-20 mx-auto mb-4 bg-gradient-to-br from-orange-100 to-amber-50 rounded-full flex items-center justify-center">
                            <span class="text-4xl">üèÜ</span>
                        </div>
                        <div class="text-lg font-semibold text-gray-700 mb-1">Be the Champion!</div>
                        <div class="text-gray-500 text-sm">Complete this test to claim the #1 spot</div>
                    </div>
                `;
                return;
            }

            // Premium leaderboard cards
            container.innerHTML = `
                <div class="space-y-3">
                    ${leaderboard.slice(0, 10).map((entry, idx) => {
                const isCurrentUser = entry.userName === currentUser.name || entry.userKey === currentUser.key;
                const acc = entry.accuracy || (entry.total > 0 ? Math.round((entry.correct / entry.total) * 100) : 0);

                // Rank badge styling
                let rankBadge, rankClass, cardBg;
                if (entry.rank === 1) {
                    rankBadge = 'ü•á';
                    rankClass = 'text-2xl';
                    cardBg = 'bg-gradient-to-r from-amber-50 via-yellow-50 to-amber-50 border-amber-200';
                } else if (entry.rank === 2) {
                    rankBadge = 'ü•à';
                    rankClass = 'text-xl';
                    cardBg = 'bg-gradient-to-r from-gray-50 via-slate-50 to-gray-50 border-gray-200';
                } else if (entry.rank === 3) {
                    rankBadge = 'ü•â';
                    rankClass = 'text-xl';
                    cardBg = 'bg-gradient-to-r from-orange-50 via-amber-50 to-orange-50 border-orange-200';
                } else {
                    rankBadge = '#' + entry.rank;
                    rankClass = 'text-sm font-bold text-gray-500';
                    cardBg = 'bg-white border-gray-100';
                }

                if (isCurrentUser) {
                    cardBg = 'bg-gradient-to-r from-blue-50 via-indigo-50 to-blue-50 border-blue-300 ring-2 ring-blue-200';
                }

                return `
                            <div class="flex items-center gap-4 p-4 rounded-xl border ${cardBg} transition-all hover:shadow-md">
                                <!-- Rank -->
                                <div class="w-12 h-12 flex items-center justify-center ${entry.rank <= 3 ? '' : 'bg-gray-100 rounded-full'}">
                                    <span class="${rankClass}">${rankBadge}</span>
                                </div>
                                
                                <!-- User Info -->
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2">
                                        <span class="font-semibold text-gray-900 truncate">${entry.userName}</span>
                                        ${isCurrentUser ? '<span class="px-2 py-0.5 bg-blue-100 text-blue-700 text-xs font-medium rounded-full">You</span>' : ''}
                                    </div>
                                    <div class="text-sm text-gray-500">Score: ${entry.correct}/${entry.total}</div>
                                </div>
                                
                                <!-- Accuracy Badge -->
                                <div class="text-right">
                                    <div class="inline-flex items-center px-3 py-1 rounded-full text-sm font-bold ${acc >= 80 ? 'bg-green-100 text-green-700' :
                        acc >= 60 ? 'bg-blue-100 text-blue-700' :
                            acc >= 40 ? 'bg-yellow-100 text-yellow-700' :
                                'bg-red-100 text-red-700'
                    }">
                                        ${acc}%
                                    </div>
                                </div>
                            </div>
                        `;
            }).join('')}
                </div>
                ${leaderboard.length > 10 ? `
                    <div class="text-center text-sm text-gray-500 mt-4 pt-4 border-t border-gray-100">
                        Showing top 10 of ${leaderboard.length} participants
                    </div>
                ` : ''}
                ${leaderboard.length === 1 && leaderboard[0].userName === currentUser.name ? `
                    <div class="mt-4 p-4 bg-gradient-to-r from-purple-50 to-indigo-50 rounded-xl border border-purple-100 text-center">
                        <div class="text-purple-700 font-medium">üéâ You're the first to complete this test!</div>
                        <div class="text-purple-600 text-sm mt-1">Share with friends to see who tops the leaderboard</div>
                    </div>
                ` : ''}
            `;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Results page loaded:', { testId, correct, wrong, total, timeTaken, isNewAttempt });

            // Only save if this is a new attempt (has URL data, not viewing saved)
            if (isNewAttempt && testId) {
                saveAttempt();
                // Save to Firebase for leaderboard and analytics
                console.log('üíæ Saving result to Firebase...');
                try {
                    if (window.FirebaseSync) {
                        const userData = JSON.parse(localStorage.getItem('user_data') || '{}');
                        await FirebaseSync.saveTestResult(testId, {
                            userName: userData.name || 'Anonymous',
                            userKey: userData.key || '',
                            correct, wrong, total,
                            score: (correct * 2) - (wrong * 0.66),
                            accuracy: total > 0 ? Math.round(correct / total * 100) : 0,
                            timeTaken
                        });
                        console.log('‚úÖ Firebase save completed');
                    }
                } catch (e) {
                    console.error('‚ùå Firebase save failed:', e);
                }
            } else {
                console.log('‚ÑπÔ∏è Not saving - isNewAttempt:', isNewAttempt, 'testId:', testId);
            }

            updateUI();
            animateScore();

            // Load leaderboard
            loadLeaderboard();

            // View Answers button handler
            const answersUrl = `answers.html?testId=${testId}&attempt=${attemptNum}`;
            document.getElementById('viewAnswersBtn').onclick = () => {
                window.location.href = answersUrl;
            };
        });
    </script>
</body>

</html>